service: medical-rimac-appointments

frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: 512
  timeout: 30
  environment:
    STAGE: ${self:provider.stage}
    REGION: ${self:provider.region}
    APPOINTMENTS_TABLE: ${self:custom.appointmentsTable}
    SNS_TOPIC_ARN: !Ref AppointmentsTopic
    SQS_PE_URL: !Ref AppointmentsPEQueue
    SQS_CL_URL: !Ref AppointmentsCLQueue
    SQS_RESPONSE_URL: !Ref AppointmentsResponseQueue
    EVENT_BUS_NAME: ${self:custom.eventBusName}
  iam:
    role:
      statements:
        # DynamoDB permissions
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - !GetAtt AppointmentsTable.Arn
            - !Sub '${AppointmentsTable.Arn}/index/*'
        # SNS permissions
        - Effect: Allow
          Action:
            - sns:Publish
          Resource:
            - !Ref AppointmentsTopic
        # SQS permissions
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource:
            - !GetAtt AppointmentsPEQueue.Arn
            - !GetAtt AppointmentsCLQueue.Arn
            - !GetAtt AppointmentsResponseQueue.Arn
        # EventBridge permissions
        - Effect: Allow
          Action:
            - events:PutEvents
          Resource:
            - !Sub 'arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/${self:custom.eventBusName}'

build:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    exclude:
      - aws-sdk
    target: node20

plugins:
  - serverless-offline

custom:
  appointmentsTable: medical-appointments-${self:provider.stage}
  eventBusName: medical-appointments-bus-${self:provider.stage}

functions:
  # Lambda principal: recibe peticiones y maneja el ciclo completo
  appointment:
    handler: src/presentation/handlers/appointment.handler
    events:
      - http:
          path: appointments
          method: post
          cors: true
      - http:
          path: appointments/{insuredId}
          method: get
          cors: true
      # Consume respuestas del EventBridge
      - sqs:
          arn: !GetAtt AppointmentsResponseQueue.Arn
          batchSize: 10

  # Lambda para procesar agendamientos de Per√∫
  appointmentPE:
    handler: src/presentation/handlers/appointment-pe.handler
    events:
      - sqs:
          arn: !GetAtt AppointmentsPEQueue.Arn
          batchSize: 10

  # Lambda para procesar agendamientos de Chile
  appointmentCL:
    handler: src/presentation/handlers/appointment-cl.handler
    events:
      - sqs:
          arn: !GetAtt AppointmentsCLQueue.Arn
          batchSize: 10

resources:
  Resources:
    # DynamoDB Table
    AppointmentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.appointmentsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: appointmentId
            AttributeType: S
          - AttributeName: insuredId
            AttributeType: S
        KeySchema:
          - AttributeName: appointmentId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: insuredId-index
            KeySchema:
              - AttributeName: insuredId
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    # SNS Topic
    AppointmentsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: appointments-topic-${self:provider.stage}
        DisplayName: Medical Appointments Topic
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    # SNS Subscriptions with filters
    AppointmentsPESubscription:
      Type: AWS::SNS::Subscription
      Properties:
        Protocol: sqs
        TopicArn: !Ref AppointmentsTopic
        Endpoint: !GetAtt AppointmentsPEQueue.Arn
        FilterPolicy:
          countryISO:
            - PE
        RawMessageDelivery: true

    AppointmentsCLSubscription:
      Type: AWS::SNS::Subscription
      Properties:
        Protocol: sqs
        TopicArn: !Ref AppointmentsTopic
        Endpoint: !GetAtt AppointmentsCLQueue.Arn
        FilterPolicy:
          countryISO:
            - CL
        RawMessageDelivery: true

    # SQS Queues
    AppointmentsPEQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: appointments-pe-queue-${self:provider.stage}
        VisibilityTimeout: 180
        MessageRetentionPeriod: 1209600
        ReceiveMessageWaitTimeSeconds: 20
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    AppointmentsCLQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: appointments-cl-queue-${self:provider.stage}
        VisibilityTimeout: 180
        MessageRetentionPeriod: 1209600
        ReceiveMessageWaitTimeSeconds: 20
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    AppointmentsResponseQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: appointments-response-queue-${self:provider.stage}
        VisibilityTimeout: 180
        MessageRetentionPeriod: 1209600
        ReceiveMessageWaitTimeSeconds: 20
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    # SQS Queue Policies para permitir SNS publicar
    AppointmentsPEQueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - !Ref AppointmentsPEQueue
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                Service: sns.amazonaws.com
              Action: sqs:SendMessage
              Resource: !GetAtt AppointmentsPEQueue.Arn
              Condition:
                ArnEquals:
                  aws:SourceArn: !Ref AppointmentsTopic

    AppointmentsCLQueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - !Ref AppointmentsCLQueue
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                Service: sns.amazonaws.com
              Action: sqs:SendMessage
              Resource: !GetAtt AppointmentsCLQueue.Arn
              Condition:
                ArnEquals:
                  aws:SourceArn: !Ref AppointmentsTopic

    # EventBridge Event Bus
    AppointmentsEventBus:
      Type: AWS::Events::EventBus
      Properties:
        Name: ${self:custom.eventBusName}
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}

    # EventBridge Rule para enviar eventos al SQS de respuesta
    AppointmentsCompletedRule:
      Type: AWS::Events::Rule
      Properties:
        Name: appointments-completed-rule-${self:provider.stage}
        EventBusName: !Ref AppointmentsEventBus
        EventPattern:
          source:
            - medical.appointments
          detail-type:
            - AppointmentProcessed
        State: ENABLED
        Targets:
          - Arn: !GetAtt AppointmentsResponseQueue.Arn
            Id: AppointmentsResponseQueueTarget

    # Permitir EventBridge enviar mensajes al SQS
    AppointmentsResponseQueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - !Ref AppointmentsResponseQueue
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                Service: events.amazonaws.com
              Action: sqs:SendMessage
              Resource: !GetAtt AppointmentsResponseQueue.Arn
              Condition:
                ArnEquals:
                  aws:SourceArn: !GetAtt AppointmentsCompletedRule.Arn

  Outputs:
    AppointmentsTableName:
      Value: !Ref AppointmentsTable
      Description: DynamoDB Table for appointments

    AppointmentsTopicArn:
      Value: !Ref AppointmentsTopic
      Description: SNS Topic ARN

    AppointmentsPEQueueUrl:
      Value: !Ref AppointmentsPEQueue
      Description: SQS Queue URL for Peru

    AppointmentsCLQueueUrl:
      Value: !Ref AppointmentsCLQueue
      Description: SQS Queue URL for Chile

    AppointmentsResponseQueueUrl:
      Value: !Ref AppointmentsResponseQueue
      Description: SQS Queue URL for responses

    EventBusName:
      Value: !Ref AppointmentsEventBus
      Description: EventBridge Event Bus Name

    ApiEndpoint:
      Value: !Sub 'https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/${self:provider.stage}'
      Description: API Gateway endpoint
